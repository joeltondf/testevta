#!/usr/bin/env php
<?php

declare(strict_types=1);

require_once __DIR__ . '/../config.php';
require_once __DIR__ . '/../app/services/LeadDistributor.php';
require_once __DIR__ . '/../app/services/NotificationCleanupService.php';
require_once __DIR__ . '/../app/services/OmieSyncService.php';
require_once __DIR__ . '/../app/models/Configuracao.php';

if (!isset($pdo) || !$pdo instanceof PDO) {
    fwrite(STDERR, "Conexão com o banco de dados não encontrada.\n");
    exit(1);
}

$command = $argv[1] ?? 'help';

switch ($command) {
    case 'leads:distribute':
        $leadDistributor = new LeadDistributor($pdo);
        $result = $leadDistributor->distribuirLeads();
        printf(
            "Leads processados: %d | Leads distribuídos: %d\n",
            $result['leadsProcessados'] ?? 0,
            $result['leadsDistribuidos'] ?? 0
        );
        break;

    case 'notifications:cleanup':
        $daysArgument = $argv[2] ?? null;
        $retentionDays = $daysArgument !== null ? (int) $daysArgument : null;
        $cleanupService = new NotificationCleanupService($pdo);
        $summary = $cleanupService->cleanup($retentionDays);
        printf(
            "Notificações removidas: %d | Retenção aplicada: %d dias\n",
            $summary['removed'],
            $summary['retention_days']
        );
        break;

    case 'omie:reprocess':
        $scope = $argv[2] ?? 'support';
        $configModel = new Configuracao($pdo);
        $omieService = new OmieSyncService($pdo, $configModel);

        switch ($scope) {
            case 'support':
                $summary = $omieService->syncSupportTables();
                echo "Sincronização de tabelas de suporte concluída:\n";
                foreach ($summary as $resource => $row) {
                    $updated = is_array($row) && isset($row['total']) ? (int)$row['total'] : (is_numeric($row) ? (int)$row : 0);
                    printf("- %s: %d registro(s) atualizado(s)\n", ucfirst($resource), $updated);
                }
                break;
            case 'products':
                $summary = $omieService->syncProdutos();
                $total = is_array($summary) && isset($summary['total']) ? (int)$summary['total'] : count($summary ?? []);
                printf("Produtos sincronizados: %d\n", $total);
                break;
            default:
                fwrite(STDERR, "Escopo inválido para omie:reprocess. Use 'support' ou 'products'.\n");
                exit(1);
        }
        break;

    default:
        echo "Ferramenta de manutenção VettaSBX\n";
        echo "Uso:\n";
        echo "  bin/console leads:distribute              Distribui automaticamente os leads pendentes.\n";
        echo "  bin/console notifications:cleanup [dias]  Remove notificações resolvidas acima do limite.\n";
        echo "  bin/console omie:reprocess [support|products]  Reprocessa integrações com a Omie.\n";
        exit($command === 'help' ? 0 : 1);
}
